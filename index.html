import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
  AreaChart, Area, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar
} from 'recharts';
import { 
  LayoutDashboard, PlusCircle, Activity, History, 
  Brain, Zap, Battery, Thermometer, Moon, 
  ClipboardList, AlertTriangle, Download, Users, 
  Heart, Settings, Utensils, Shield, Swords, GraduationCap, Gauge,
  Cpu, CheckCircle, ChevronRight, Play, Square, AlertOctagon
} from 'lucide-react';

// --- FIREBASE SETUP ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, onAuthStateChanged, signInAnonymously 
} from 'firebase/auth';
import { 
  getFirestore, collection, addDoc, doc, 
  onSnapshot, serverTimestamp, setDoc, getDoc 
} from 'firebase/firestore';

// ⚠️ REPLACE WITH YOUR REAL FIREBASE CONFIG ⚠️
const firebaseConfig = {
  apiKey: "", 
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

// Initialize Firebase (Conditional for "No Config" preview safety)
let app, auth, db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) {
  console.warn("Firebase not configured. Using local state mode.");
}
const appId = "nlc-production-v1";

// --- PROGRAMMING LIBRARY (Digitized from Screenshots) ---
const PROGRAM_TEMPLATES = {
  // === QUADRANT 1: PRECISION // FAST (The Sniper) ===
  "pf_strength": {
    name: "Sniper Strength (Precision/Fast)",
    type: "Strength",
    protocol: "Max Strength",
    category: "Precision",
    exercises: [
      { name: "A. Box Jumps", sets: 5, reps: "3", weight: "Max Height", rpe: 9, notes: "Full recovery." },
      { name: "B. Trap Bar DL", sets: 5, reps: "3", weight: "Heavy", rpe: 8, notes: "Explosive concentric." },
      { name: "C. Weighted Pull Up", sets: 5, reps: "3", weight: "Heavy", rpe: 8, notes: "3 mins rest." },
      { name: "D. Farmers Carry", sets: 3, reps: "20s", weight: "Heavy", rpe: 9, notes: "Short & Heavy." }
    ]
  },
  "strength_a": {
    name: "Strength A (Zercher/DL)",
    type: "Strength",
    protocol: "Max Strength",
    category: "Precision",
    exercises: [
      { name: "Warm Up", sets: 1, reps: "Flow", weight: "-", rpe: 1 },
      { name: "Pull Ups", sets: 5, reps: "3", weight: "BW", rpe: 8 },
      { name: "Zercher Squat", sets: 5, reps: "3", weight: "Heavy", rpe: 7 },
      { name: "Deadlift", sets: 5, reps: "5", weight: "Heavy", rpe: 7 },
      { name: "Mace Flow", sets: 1, reps: "6 mins", weight: "-", rpe: 6 }
    ]
  },

  // === QUADRANT 2: PRECISION // SLOW (The Architect) ===
  "ps_strength": {
    name: "Architect Strength (Precision/Slow)",
    type: "Strength",
    protocol: "Hypertrophy",
    category: "Precision",
    exercises: [
      { name: "A. Tempo Squat", sets: 4, reps: "6", weight: "Medium", rpe: 8, notes: "Tempo: 3030." },
      { name: "B. Ring Rows", sets: 4, reps: "8-10", weight: "BW", rpe: 8, notes: "Pause 2s at top." },
      { name: "C. RDL", sets: 4, reps: "8", weight: "Medium", rpe: 7 },
      { name: "D. Dead Bug", sets: 3, reps: "12", weight: "BW", rpe: 7 }
    ]
  },

  // === QUADRANT 3: CAPACITY // FAST (The Blitz) ===
  "cf_hybrid": {
    name: "Blitz Hybrid (Capacity/Fast)",
    type: "Hybrid",
    protocol: "Power Endurance",
    category: "Capacity",
    exercises: [
      { name: "EMOM 10: Power Clean", sets: 10, reps: "3", weight: "Medium", rpe: 7 },
      { name: "A1. Front Squat", sets: 4, reps: "5", weight: "Medium", rpe: 8 },
      { name: "A2. Box Jump", sets: 4, reps: "5", weight: "BW", rpe: 8 },
      { name: "Finisher: KB Swing", sets: 1, reps: "100", weight: "24kg", rpe: 9 }
    ]
  },
  "hybrid_a": {
    name: "Hybrid A (Warrior)",
    type: "Hybrid",
    protocol: "Power/Strength",
    category: "Capacity",
    exercises: [
      { name: "Warm Up Circuit", sets: 1, reps: "1 round", weight: "-", rpe: 2 },
      { name: "Power: Clean & Press", sets: 3, reps: "10", weight: "Medium", rpe: 7 },
      { name: "Str: Pull Up", sets: 5, reps: "4", weight: "BW", rpe: 8 },
      { name: "Str: Zercher Squat", sets: 5, reps: "3", weight: "Heavy", rpe: 8 },
      { name: "Finisher: Farmers Carry", sets: 5, reps: "30s", weight: "Heavy", rpe: 9 }
    ]
  },

  // === QUADRANT 4: CAPACITY // SLOW (The Diesel) ===
  "cs_hypertrophy": {
    name: "Diesel Mass (Capacity/Slow)",
    type: "Strength",
    protocol: "Hypertrophy",
    category: "Capacity",
    exercises: [
      { name: "A. Back Squat (Wave)", sets: 4, reps: "10/8/6/20", weight: "Wave", rpe: 9 },
      { name: "B. DB Bench Press", sets: 4, reps: "12-15", weight: "Medium", rpe: 9 },
      { name: "C1. Lunges", sets: 3, reps: "20", weight: "BW", rpe: 8 },
      { name: "C2. Push Ups", sets: 3, reps: "Max", weight: "BW", rpe: 9 },
      { name: "Finisher: Sled Push", sets: 1, reps: "10 mins", weight: "Heavy", rpe: 10 }
    ]
  },
  "abc_standard": {
    name: "Dan John's ABC",
    type: "Strength",
    protocol: "Hypertrophy",
    category: "Capacity",
    exercises: [
      { name: "Armour Building Complex", sets: 30, reps: "1 cycle", weight: "Double KB", rpe: 6, notes: "EMOM 30 mins." }
    ]
  },

  // --- RECOVERY (Universal) ---
  "zone_2": {
    name: "Zone 2 Base",
    type: "Cardio",
    protocol: "Zone 2",
    category: "Recovery",
    exercises: [
      { name: "Run/Row/Bike", sets: 1, reps: "30-45m", weight: "-", rpe: 3, notes: "Nose breathing only. HR < 140." }
    ]
  },
  "cool_down_full": {
    name: "NLC Full Mobility",
    type: "Recovery",
    protocol: "Mobility",
    category: "Recovery",
    exercises: [
      { name: "Passive Hang", sets: 1, reps: "20s", weight: "BW", rpe: 1 },
      { name: "Big Three Holds", sets: 4, reps: "10s", weight: "BW", rpe: 2 },
      { name: "90/90 Stretch", sets: 1, reps: "2 mins", weight: "BW", rpe: 1 },
      { name: "Cobra Pose", sets: 1, reps: "10x", weight: "BW", rpe: 1 }
    ]
  }
};

// --- QUIZ DATA ---
const ASSESSMENT_QUESTIONS = [
  { id: 1, category: 'OS', text: "Two hours after a super high-intensity workout, how do you feel?", optionA: "Wired, anxious, hard to sleep.", optionB: "Relaxed, hungry, good 'tired'.", valA: 'Precision', valB: 'Capacity' },
  { id: 2, category: 'OS', text: "When learning a complex new skill, you prefer...", optionA: "Silence, structure, perfect reps.", optionB: "Trial and error, figuring it out.", valA: 'Precision', valB: 'Capacity' },
  { id: 3, category: 'OS', text: "Under high life stress, your training usually...", optionA: "Suffers. You need to back off.", optionB: "Is your escape. You go harder.", valA: 'Precision', valB: 'Capacity' },
  { id: 4, category: 'Engine', text: "Historically, which sports were you better at?", optionA: "Sprints, Jumps, Striking (Power).", optionB: "Distance, Rugby 80m, Rowing.", valA: 'Fast', valB: 'Slow' },
  { id: 5, category: 'Engine', text: "If you do a 5RM squat set, how do you feel about a 6th rep?", optionA: "Impossible. Power drops off a cliff.", optionB: "I could grind out 2-3 more ugly reps.", valA: 'Fast', valB: 'Slow' },
  { id: 6, category: 'Engine', text: "How do your muscles feel the day after volume training?", optionA: "Deep soreness, wrecked for days.", optionB: "Mild soreness, ready to go again.", valA: 'Fast', valB: 'Slow' }
];

// --- COMPONENTS ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-[#111] border border-gray-800 rounded-sm shadow-sm ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, color = "gray" }) => {
  const colors = {
    orange: "bg-orange-900/30 text-orange-500 border-orange-800",
    green: "bg-emerald-900/30 text-emerald-500 border-emerald-800",
    blue: "bg-blue-900/30 text-blue-500 border-blue-800",
    gray: "bg-gray-800 text-gray-400 border-gray-700",
  };
  return (
    <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider border ${colors[color] || colors.gray}`}>
      {children}
    </span>
  );
};

const SectionHeader = ({ title, icon: Icon }) => (
  <div className="flex items-center gap-2 mb-4 pb-2 border-b border-gray-800">
    {Icon && <Icon size={16} className="text-orange-500" />}
    <h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest">{title}</h2>
  </div>
);

// --- MAIN APPLICATION ---

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('dashboard'); 
  const [workouts, setWorkouts] = useState([]);
  const [checkins, setCheckins] = useState([]);
  const [profile, setProfile] = useState({ name: 'Athlete', goal: '', os: 'Unknown', engine: 'Unknown', isCompeting: false });
  const [loading, setLoading] = useState(true);

  // --- Auth & Data Init ---
  useEffect(() => {
    if (auth) {
      signInAnonymously(auth).catch(console.error);
      return onAuthStateChanged(auth, (u) => {
        setUser(u);
        if (u) setLoading(false);
      });
    } else {
      setLoading(false); // Dev mode
    }
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    
    // Listeners for real-time updates would go here
    // For this artifact, we will rely on local state updates for responsiveness
    // In a real app, you'd use onSnapshot()
  }, [user]);

  // --- Calculations ---
  const stats = useMemo(() => {
    const totalMins = workouts.reduce((acc, curr) => acc + (parseInt(curr.duration) || 0), 0);
    // Determine system status based on latest checkin
    const lastCheck = checkins[0];
    const systemStatus = lastCheck?.soreness > 3 ? "WARNING" : "OPTIMAL";
    return { totalMins, systemStatus };
  }, [workouts, checkins]);

  // --- VIEWS ---

  const Sidebar = () => (
    <div className="w-full md:w-64 bg-[#050505] border-r border-gray-800 flex-shrink-0 flex flex-col h-full font-mono text-sm">
      <div className="p-6 border-b border-gray-800 flex flex-col items-center text-center">
        <div className="mb-4 h-16 w-16 relative flex items-center justify-center border-2 border-orange-600 rounded-full">
           <div className="text-2xl font-black text-orange-500 tracking-tighter">NLC</div>
        </div>
        <div className="font-bold tracking-widest text-white">NLC <span className="text-orange-500">PERF.</span></div>
        <p className="text-[10px] text-gray-500 uppercase mt-1">Tactical Holistic</p>
      </div>

      <nav className="flex-1 px-2 space-y-1 py-6">
        {[
          { id: 'dashboard', label: 'System Status', icon: LayoutDashboard },
          { id: 'assessment', label: 'Diagnostic', icon: Gauge },
          { id: 'checkin', label: '4 Doctors Check', icon: ClipboardList },
          { id: 'log', label: 'Log Protocol', icon: PlusCircle },
          { id: 'history', label: 'Data Logs', icon: History },
          { id: 'settings', label: 'Configuration', icon: Settings },
        ].map((item) => (
          <button 
            key={item.id}
            onClick={() => setView(item.id)}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-sm transition-all ${
              view === item.id 
                ? 'bg-orange-900/20 text-orange-500 border-r-2 border-orange-500' 
                : 'text-gray-500 hover:text-gray-300 hover:bg-gray-900'
            }`}
          >
            <item.icon size={16} />
            <span className="uppercase tracking-wider font-medium">{item.label}</span>
          </button>
        ))}
      </nav>

      <div className="p-4 border-t border-gray-800">
        <div className="bg-gray-900 p-3 rounded border border-gray-800">
          <div className="text-xs text-gray-500 uppercase mb-1">Profile Loaded</div>
          <div className="text-white font-bold flex items-center gap-2">
            <div className={`w-2 h-2 rounded-full ${profile.isCompeting ? 'bg-red-500' : 'bg-green-500'}`}></div>
            {profile.name}
          </div>
          <div className="text-xs text-orange-500 mt-1 font-mono">{profile.os} // {profile.engine}</div>
        </div>
      </div>
    </div>
  );

  const DashboardView = () => {
    // 4 Doctors Data (Mock)
    const doctorData = [
      { subject: 'Dr. Diet', A: 80, fullMark: 100 },
      { subject: 'Dr. Quiet', A: 65, fullMark: 100 },
      { subject: 'Dr. Happy', A: 90, fullMark: 100 },
      { subject: 'Dr. Move', A: 70, fullMark: 100 },
    ];

    return (
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="flex justify-between items-end border-b border-gray-800 pb-4">
          <div>
            <h1 className="text-3xl font-black text-white uppercase tracking-tight">System Overview</h1>
            <p className="text-gray-500 font-mono text-xs mt-1">BIO-METRIC TELEMETRY: ACTIVE</p>
          </div>
          <div className="flex gap-2">
             <div className="px-4 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-gray-400 font-mono flex items-center gap-2">
               STATUS: <span className={stats.systemStatus === 'OPTIMAL' ? 'text-green-500' : 'text-red-500'}>{stats.systemStatus}</span>
             </div>
          </div>
        </header>

        {/* ALERTS */}
        {profile.isCompeting && (
          <div className="bg-red-900/20 border-l-2 border-red-600 p-4 flex items-center gap-4">
             <AlertOctagon className="text-red-500" />
             <div>
               <h3 className="text-red-500 font-bold uppercase text-sm">Competition Protocol Active</h3>
               <p className="text-red-400 text-xs">Volume restricted. Prioritizing nervous system recovery.</p>
             </div>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* LEFT COL: 4 DOCTORS */}
          <Card className="p-6 col-span-1">
            <SectionHeader title="4 Doctors Status" icon={Activity} />
            <div className="h-64 w-full flex items-center justify-center">
              <ResponsiveContainer width="100%" height="100%">
                <RadarChart cx="50%" cy="50%" outerRadius="70%" data={doctorData}>
                  <PolarGrid stroke="#333" />
                  <PolarAngleAxis dataKey="subject" tick={{ fill: '#666', fontSize: 10 }} />
                  <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                  <Radar name="Status" dataKey="A" stroke="#ea580c" fill="#ea580c" fillOpacity={0.3} />
                </RadarChart>
              </ResponsiveContainer>
            </div>
            <div className="grid grid-cols-2 gap-2 mt-4 text-center">
               <div className="bg-gray-900 p-2 rounded border border-gray-800">
                 <div className="text-[10px] text-gray-500 uppercase">Dr. Quiet</div>
                 <div className="text-white font-mono font-bold">65%</div>
               </div>
               <div className="bg-gray-900 p-2 rounded border border-gray-800">
                 <div className="text-[10px] text-gray-500 uppercase">Dr. Diet</div>
                 <div className="text-white font-mono font-bold">80%</div>
               </div>
            </div>
          </Card>

          {/* CENTER COL: RECOMMENDED PROTOCOL */}
          <div className="lg:col-span-2 space-y-4">
             <Card className="p-6 h-full flex flex-col justify-center relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-10">
                   <Brain size={120} className="text-white" />
                </div>
                <SectionHeader title="Operating System Recommendation" icon={Cpu} />
                
                <div className="mb-6">
                   <h3 className="text-2xl text-white font-bold mb-2">
                     {profile.os === 'Precision' ? 'NEURAL PROTOCOL' : profile.os === 'Capacity' ? 'CAPACITY PROTOCOL' : 'EXPLORER PHASE'}
                   </h3>
                   <p className="text-gray-400 text-sm max-w-md">
                     {profile.os === 'Precision' 
                       ? 'System sensitivity high. Prioritize low reps, perfect mechanics, and extended rest intervals. Avoid lactate accumulation.'
                       : profile.os === 'Capacity' 
                       ? 'Metabolic tolerance high. Prioritize density, incomplete rest, and volume accumulation. Feed the engine.'
                       : 'Baseline testing required. Execute diagnostic protocols to determine neuro-physical coordinates.'}
                   </p>
                </div>

                <div className="flex gap-4">
                   <button onClick={() => setView('log')} className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-sm text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                     <Play size={16} fill="currentColor" /> Initiate Session
                   </button>
                   <button onClick={() => setView('checkin')} className="bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-sm text-sm font-bold uppercase tracking-wider">
                     Update Bio-Metrics
                   </button>
                </div>
             </Card>
          </div>
        </div>
      </div>
    );
  };

  const AssessmentView = () => {
    const [step, setStep] = useState(0);
    const [scores, setScores] = useState({ os: 0, engine: 0 });

    const handleAnswer = (val, category) => {
      setScores(prev => ({
        ...prev,
        [category.toLowerCase()]: prev[category.toLowerCase()] + (val === 'A' ? 1 : -1)
      }));
      if (step < ASSESSMENT_QUESTIONS.length - 1) {
        setStep(step + 1);
      } else {
        finishAssessment();
      }
    };

    const finishAssessment = () => {
      const finalOS = scores.os >= 0 ? 'Precision' : 'Capacity';
      const finalEngine = scores.engine >= 0 ? 'Fast' : 'Slow';
      const newProfile = { ...profile, os: finalOS, engine: finalEngine };
      setProfile(newProfile);
      setStep(ASSESSMENT_QUESTIONS.length);
    };

    if (step === ASSESSMENT_QUESTIONS.length) {
      return (
        <div className="max-w-2xl mx-auto pt-10 text-center">
           <div className="bg-gray-900 border border-orange-500/50 p-8 rounded-sm relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-1 bg-orange-500"></div>
              <CheckCircle size={48} className="text-orange-500 mx-auto mb-4" />
              <h2 className="text-2xl font-bold text-white uppercase tracking-widest mb-2">Diagnostic Complete</h2>
              <p className="text-gray-400 mb-8 font-mono">NEURO-PHYSICAL COORDINATES ESTABLISHED</p>
              
              <div className="grid grid-cols-2 gap-4 mb-8">
                 <div className="bg-black p-4 border border-gray-800">
                    <div className="text-xs text-gray-500 uppercase font-bold">OS (Brain)</div>
                    <div className="text-xl text-white font-mono">{profile.os}</div>
                 </div>
                 <div className="bg-black p-4 border border-gray-800">
                    <div className="text-xs text-gray-500 uppercase font-bold">Engine (Body)</div>
                    <div className="text-xl text-white font-mono">{profile.engine}</div>
                 </div>
              </div>
              <button onClick={() => setView('dashboard')} className="text-orange-500 hover:text-white uppercase text-sm font-bold tracking-widest">Return to Command &rarr;</button>
           </div>
        </div>
      );
    }

    const q = ASSESSMENT_QUESTIONS[step];

    return (
      <div className="max-w-xl mx-auto pt-10">
        <div className="mb-8 flex justify-between items-end">
           <span className="text-xs font-bold text-orange-500 uppercase tracking-widest">Diagnostic Sequence {step + 1} / {ASSESSMENT_QUESTIONS.length}</span>
           <span className="text-xs font-mono text-gray-600">{Math.round(((step)/ASSESSMENT_QUESTIONS.length)*100)}%</span>
        </div>
        <div className="w-full bg-gray-900 h-1 mb-8">
           <div className="bg-orange-600 h-1 transition-all duration-300" style={{width: `${((step)/ASSESSMENT_QUESTIONS.length)*100}%`}}></div>
        </div>

        <Card className="p-8">
           <h2 className="text-lg font-bold text-white mb-8 leading-relaxed">{q.text}</h2>
           <div className="space-y-4">
             <button onClick={() => handleAnswer('A', q.category)} className="w-full text-left p-4 bg-gray-900 border border-gray-800 hover:border-orange-500 transition-all group">
               <div className="font-mono text-orange-500 text-xs mb-1">OPTION A</div>
               <div className="text-gray-300 group-hover:text-white">{q.optionA}</div>
             </button>
             <button onClick={() => handleAnswer('B', q.category)} className="w-full text-left p-4 bg-gray-900 border border-gray-800 hover:border-orange-500 transition-all group">
               <div className="font-mono text-orange-500 text-xs mb-1">OPTION B</div>
               <div className="text-gray-300 group-hover:text-white">{q.optionB}</div>
             </button>
           </div>
        </Card>
      </div>
    );
  };

  const CheckInView = () => {
    const [formData, setFormData] = useState({ sleep: 3, soreness: 2, stress: 2, diet: 3, purpose: 3, grip: '', co2: '' });
    
    const handleSubmit = (e) => {
      e.preventDefault();
      const newCheckin = { ...formData, date: new Date().toISOString() };
      setCheckins([newCheckin, ...checkins]);
      setView('dashboard');
    };

    const SliderGroup = ({ label, icon: Icon, value, setter }) => (
      <div>
        <div className="flex justify-between mb-2">
          <label className="text-xs font-bold text-gray-400 uppercase flex items-center gap-2"><Icon size={14} className="text-orange-500"/> {label}</label>
          <span className="text-xs font-mono text-white">{value}/5</span>
        </div>
        <div className="flex gap-1">
          {[1,2,3,4,5].map(v => (
            <button key={v} type="button" onClick={() => setter(v)} className={`h-8 flex-1 border border-gray-800 ${value >= v ? 'bg-orange-600' : 'bg-gray-900'}`}></button>
          ))}
        </div>
      </div>
    );

    return (
      <div className="max-w-xl mx-auto">
        <header className="mb-6"><h1 className="text-2xl font-black text-white uppercase">Daily Bio-Metrics</h1></header>
        <Card className="p-6">
          <form onSubmit={handleSubmit} className="space-y-8">
            <div className="space-y-6">
              <SectionHeader title="The 4 Doctors" icon={Heart} />
              <SliderGroup label="Dr. Quiet (Sleep Quality)" icon={Moon} value={formData.sleep} setter={v => setFormData({...formData, sleep: v})} />
              <SliderGroup label="Dr. Diet (Digestion/Fuel)" icon={Utensils} value={formData.diet} setter={v => setFormData({...formData, diet: v})} />
              <SliderGroup label="Dr. Happiness (Purpose)" icon={Brain} value={formData.purpose} setter={v => setFormData({...formData, purpose: v})} />
            </div>

            <div className="space-y-6 pt-6 border-t border-gray-800">
              <SectionHeader title="System Load" icon={Activity} />
              <SliderGroup label="Structural Stress (Soreness)" icon={Thermometer} value={formData.soreness} setter={v => setFormData({...formData, soreness: v})} />
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs font-bold text-gray-400 uppercase block mb-2">Grip Strength (kg)</label>
                  <input type="number" className="w-full bg-gray-900 border border-gray-800 text-white p-2 font-mono" value={formData.grip} onChange={e => setFormData({...formData, grip: e.target.value})} placeholder="00.0" />
                </div>
                <div>
                  <label className="text-xs font-bold text-gray-400 uppercase block mb-2">CO2 Tolerance (sec)</label>
                  <input type="number" className="w-full bg-gray-900 border border-gray-800 text-white p-2 font-mono" value={formData.co2} onChange={e => setFormData({...formData, co2: e.target.value})} placeholder="00" />
                </div>
              </div>
            </div>

            <button type="submit" className="w-full bg-white text-black font-bold uppercase tracking-widest py-3 hover:bg-gray-200">Submit Telemetry</button>
          </form>
        </Card>
      </div>
    );
  };

  const LogWorkoutView = () => {
    const [selectedTemplate, setSelectedTemplate] = useState(null);
    
    // Filter Logic
    const showPrecisionFast = (profile.os === 'Precision' && profile.engine === 'Fast');
    const showPrecisionSlow = (profile.os === 'Precision' && profile.engine === 'Slow');
    const showCapacityFast = (profile.os === 'Capacity' && profile.engine === 'Fast');
    const showCapacitySlow = (profile.os === 'Capacity' && profile.engine === 'Slow');
    
    const ProgramButton = ({ templateKey, label, subLabel }) => (
      <button onClick={() => setSelectedTemplate(PROGRAM_TEMPLATES[templateKey])} className="text-left bg-gray-900 border border-gray-800 p-4 hover:border-orange-500 transition-all group">
        <div className="text-white font-bold text-sm mb-1 group-hover:text-orange-500">{label}</div>
        <div className="text-gray-500 text-xs font-mono">{subLabel}</div>
      </button>
    );

    if (selectedTemplate) {
      return (
        <div className="max-w-2xl mx-auto">
           <button onClick={() => setSelectedTemplate(null)} className="text-gray-500 text-xs uppercase font-bold mb-4 hover:text-white">&larr; Back to Selection</button>
           <Card className="p-0 overflow-hidden">
             <div className="bg-gray-900 p-6 border-b border-gray-800">
               <h2 className="text-xl font-bold text-white uppercase">{selectedTemplate.name}</h2>
               <div className="flex gap-2 mt-2">
                 <Badge color="orange">{selectedTemplate.category}</Badge>
                 <Badge color="gray">{selectedTemplate.protocol}</Badge>
               </div>
             </div>
             <div className="p-6 space-y-4">
               {selectedTemplate.exercises.map((ex, i) => (
                 <div key={i} className="flex items-start gap-4 pb-4 border-b border-gray-800 last:border-0">
                   <div className="mt-1"><Square size={16} className="text-gray-600" /></div>
                   <div className="flex-1">
                     <div className="text-white font-bold text-sm">{ex.name}</div>
                     {ex.notes && <div className="text-gray-500 text-xs italic mt-1">{ex.notes}</div>}
                   </div>
                   <div className="text-right font-mono text-xs text-orange-500">
                     <div>{ex.sets} x {ex.reps}</div>
                     <div>{ex.weight}</div>
                   </div>
                 </div>
               ))}
             </div>
             <div className="p-6 bg-gray-900 border-t border-gray-800">
                <button onClick={() => { 
                  setWorkouts([...workouts, { ...selectedTemplate, date: new Date().toISOString(), duration: 60 }]); 
                  setView('dashboard'); 
                }} className="w-full bg-orange-600 text-white font-bold uppercase tracking-widest py-3 hover:bg-orange-500">
                  Complete Session
                </button>
             </div>
           </Card>
        </div>
      );
    }

    return (
      <div className="max-w-4xl mx-auto space-y-8">
        <header><h1 className="text-2xl font-black text-white uppercase">Initialize Protocol</h1></header>
        
        {!profile.isCompeting && (
          <div className="space-y-4">
            <SectionHeader title="Recommended For Your Profile" icon={Zap} />
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {showPrecisionFast && <ProgramButton templateKey="pf_strength" label="Sniper Strength" subLabel="Low Reps / High Rest" />}
              {showPrecisionSlow && <ProgramButton templateKey="ps_strength" label="Architect Strength" subLabel="Tempo / Control" />}
              {showCapacityFast && <ProgramButton templateKey="cf_hybrid" label="Blitz Hybrid" subLabel="EMOM / Power" />}
              {showCapacitySlow && <ProgramButton templateKey="cs_hypertrophy" label="Diesel Mass" subLabel="High Volume Pump" />}
              {(!profile.os || profile.os === 'Unknown') && <div className="text-gray-500 text-sm italic col-span-2">Complete Diagnostic to see recommendations.</div>}
            </div>
          </div>
        )}

        <div className="space-y-4">
          <SectionHeader title="Recovery & Maintenance" icon={Heart} />
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <ProgramButton templateKey="zone_2" label="Zone 2 Base" subLabel="30m Nose Only" />
            <ProgramButton templateKey="cool_down_full" label="Full Mobility" subLabel="Flow" />
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="h-screen w-full flex bg-[#0a0a0a] text-gray-300 font-sans overflow-hidden">
      <div className="hidden md:block"><Sidebar /></div>
      <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
        {/* Mobile Header */}
        <div className="md:hidden bg-black p-4 flex justify-between items-center border-b border-gray-800">
           <div className="font-bold tracking-wider text-white">NLC <span className="text-orange-500">PERF.</span></div>
           <div className="text-xs font-mono text-orange-500">{profile.os.substring(0,3)}//{profile.engine.substring(0,3)}</div>
        </div>
        {/* Mobile Nav */}
        <div className="md:hidden bg-black border-b border-gray-800 flex justify-around p-2">
           <button onClick={() => setView('dashboard')} className={`p-2 rounded ${view==='dashboard'?'text-orange-500':'text-gray-600'}`}><LayoutDashboard size={20}/></button>
           <button onClick={() => setView('checkin')} className={`p-2 rounded ${view==='checkin'?'text-orange-500':'text-gray-600'}`}><ClipboardList size={20}/></button>
           <button onClick={() => setView('log')} className={`p-2 rounded ${view==='log'?'text-orange-500':'text-gray-600'}`}><PlusCircle size={20}/></button>
        </div>

        <main className="flex-1 overflow-y-auto p-4 md:p-8">
          {view === 'dashboard' && <DashboardView />}
          {view === 'assessment' && <AssessmentView />}
          {view === 'checkin' && <CheckInView />}
          {view === 'log' && <LogWorkoutView />}
          {/* History/Settings placeholders */}
          {view === 'history' && <div className="text-center pt-20 text-gray-600 font-mono">NO LOGS FOUND</div>}
          {view === 'settings' && <div className="text-center pt-20 text-gray-600 font-mono">SYSTEM CONFIG LOCKED</div>}
        </main>
      </div>
    </div>
  );
}
